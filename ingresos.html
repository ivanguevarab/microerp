<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrar Ingreso - MicroERP</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #64748b;
            --background-color: #f8fafc;
            --surface-color: #ffffff;
            --text-color: #0f172a;
            --border-color: #e2e8f0;
            --success-color: #22c55e;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.5;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #354a5f 0%, #456178 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);

            /* Responsive */
            @media (max-width: 768px) {
                .container {
                    padding: 20px 15px;
                }

                .page-header {
                    flex-direction: column;
                    align-items: flex-start;
                    gap: 15px;
                }

                .table-container {
                    overflow-x: auto;
                }

                table {
                    min-width: 600px;
                }

                .modal-content {
                    margin: 20px;
                }
            }

            /* Estilos para el Buscador Google-Style (Adaptado de Egresos) */
            .search-container {
                position: relative;
                width: 100%;
            }

            .search-input {
                width: 100%;
                padding: 12px 20px;
                padding-left: 45px;
                border-radius: 8px;
                border: 2px solid #e0e0e0;
                font-size: 14px;
                transition: all 0.3s ease;
                background: #fff;
            }

            .search-input:focus {
                outline: none;
                border-color: #0070f2;
                box-shadow: 0 4px 12px rgba(0, 112, 242, 0.1);
            }

            .search-input:disabled {
                background-color: #f5f5f5;
                cursor: not-allowed;
            }

            .search-icon-input {
                position: absolute;
                left: 15px;
                top: 50%;
                transform: translateY(-50%);
                color: #7f8c8d;
                font-size: 16px;
            }

            .search-results {
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: white;
                border-radius: 8px;
                margin-top: 8px;
                box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
                z-index: 1000;
                display: none;
                max-height: 300px;
                overflow-y: auto;
                border: 1px solid #e0e0e0;
            }

            .result-item {
                padding: 12px 20px;
                cursor: pointer;
                border-bottom: 1px solid #f0f0f0;
                transition: background 0.2s;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .result-item:hover {
                background-color: #f8f9fa;
            }

            .result-item:last-child {
                border-bottom: none;
            }

            .item-code {
                font-size: 12px;
                color: #7f8c8d;
                background: #f0f2f5;
                padding: 2px 6px;
                border-radius: 4px;
                margin-left: 8px;
            }

            .item-stock {
                font-size: 12px;
                font-weight: 600;
                color: #2e7d32;
            }

            color: white;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header h1 {
            font-size: 24px;
            letter-spacing: 1px;
        }

        .btn-back {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .btn-back:hover {
            background: rgba(255, 255, 255, 0.3);
            color: white;
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
            display: grid;
            gap: 2rem;
        }

        /* Cards */
        .card {
            background: var(--surface-color);
            border-radius: 1rem;
            padding: 2rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Form Grid */
        /* Estilos para el Buscador Google-Style */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 16px 24px;
            padding-left: 50px;
            border-radius: 24px;
            border: 1px solid #e5e7eb;
            background-color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            font-size: 1.1rem;
            transition: all 0.3s ease;
            cursor: text;
            /* El input es para escribir */
        }

        .search-input:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .search-input:focus {
            outline: none;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6;
        }

        .search-icon {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 1.2rem;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 16px;
            margin-top: 8px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 50;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }

        .result-item {
            padding: 12px 20px;
            cursor: pointer;
            /* Manito en los resultados */
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.2s;
        }

        .result-item:hover {
            background-color: #f9fafb;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        label {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--secondary-color);
        }

        input,
        select,
        textarea {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
            margin-top: 1rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.875rem;
        }

        th,
        td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: #f8fafc;
            font-weight: 600;
            color: var(--secondary-color);
        }

        .col-action {
            width: 50px;
            text-align: center;
        }

        .col-number {
            text-align: right;
            width: 120px;
        }

        .btn-icon {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            padding: 0.25rem;
            border-radius: 0.25rem;
            transition: background 0.2s;
        }

        .btn-delete {
            color: var(--danger-color);
        }

        .btn-delete:hover {
            background-color: #fee2e2;
        }

        /* Footer Actions */
        .actions-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .btn-secondary {
            background-color: #e2e8f0;
            color: var(--secondary-color);
        }

        .btn-secondary:hover {
            background-color: #cbd5e1;
        }

        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background-color: #1d4ed8;
        }

        /* Totals Section */
        .totals-section {
            display: flex;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        .totals-card {
            background: #f8fafc;
            padding: 2rem;
            border-radius: 1rem;
            width: auto;
            min-width: 450px;
            max-width: 600px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--border-color);
        }

        .total-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
            color: var(--secondary-color);
        }

        .total-row span:last-child {
            font-weight: 600;
            color: var(--text-color);
        }

        .total-row.final {
            margin-top: 1.5rem;
            padding-top: 1rem;
            border-top: 2px solid var(--border-color);
            font-weight: 800;
            font-size: 1.25rem;
            color: var(--primary-color);
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: white;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            transform: translateY(150%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .toast.active {
            transform: translateY(0);
        }

        .toast.success {
            border-left: 4px solid var(--success-color);
        }

        .toast.error {
            border-left: 4px solid var(--danger-color);
        }

        .toast.warning {
            border-left: 4px solid var(--warning-color);
        }

        /* Estilos para el Buscador Google-Style (Adaptado de Egresos) */
        .search-container {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 12px 20px;
            padding-left: 45px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #fff;
        }

        .search-input:focus {
            outline: none;
            border-color: #0070f2;
            box-shadow: 0 4px 12px rgba(0, 112, 242, 0.1);
        }

        .search-input:disabled {
            background-color: #f5f5f5;
            cursor: not-allowed;
        }

        .search-icon-input {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #7f8c8d;
            font-size: 16px;
        }

        .search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border-radius: 8px;
            margin-top: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            display: none;
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
        }

        .result-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-item:hover {
            background-color: #f8f9fa;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .item-code {
            font-size: 12px;
            color: #7f8c8d;
            background: #f0f2f5;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: 8px;
        }

        .item-stock {
            font-size: 12px;
            font-weight: 600;
            color: #2e7d32;
        }

        /* Mobile Optimization */
        @media (max-width: 480px) {
            .header {
                position: relative;
                /* Scrollable header */
            }

            .header-right {
                display: none;
                /* Hide date on mobile */
            }
        }

        /* Custom Grid for Items Section */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.5rem;
            align-items: end;
        }

        .search-group {
            grid-column: span 2;
        }

        .cantidad-group {
            grid-column: span 1;
        }

        .modo-group {
            grid-column: span 1;
        }

        .monto-group {
            grid-column: span 1;
        }

        .button-group {
            grid-column: span 1;
        }

        @media (max-width: 900px) {
            .items-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .search-group {
                grid-column: span 2;
            }

            .cantidad-group {
                grid-column: span 1;
            }

            .modo-group {
                grid-column: span 1;
            }

            .monto-group {
                grid-column: span 1;
            }

            .button-group {
                grid-column: span 1;
            }
        }

        @media (max-width: 600px) {
            .items-grid {
                grid-template-columns: 1fr;
            }

            .search-group,
            .cantidad-group,
            .modo-group,
            .monto-group,
            .button-group {
                grid-column: span 1;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>
    <!-- Header -->
    <header class="header">
        <div class="header-left">
            <button class="btn-back" onclick="window.location.href='gestion_inventarios.html'">
                ‚Üê Volver
            </button>
            <h1>MICRO ERP</h1>
        </div>
        <div class="header-right">
            <span id="fechaActual" style="color: white; font-weight: 500;"></span>
        </div>
    </header>

    <main class="container">
        <!-- 1. Datos Generales -->
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">üìÑ Datos Generales</h2>
            </div>
            <form id="formIngreso" class="form-grid">
                <!-- Tipo de Ingreso -->
                <div class="form-group">
                    <label for="tipoIngreso">Tipo de Ingreso *</label>
                    <select id="tipoIngreso" required>
                        <option value="">Cargando...</option>
                    </select>
                </div>

                <!-- Proveedor -->
                <!-- Proveedor -->
                <div class="form-group">
                    <label for="proveedor">Proveedor *</label>
                    <select id="proveedor" required>
                        <option value="">Cargando...</option>
                    </select>
                </div>

                <!-- Almac√©n Destino -->
                <div class="form-group">
                    <label for="almacen">Almac√©n Destino *</label>
                    <select id="almacen" required>
                        <option value="">Cargando...</option>
                    </select>
                </div>

                <!-- Fecha Ingreso -->
                <div class="form-group">
                    <label for="fechaEmision">Fecha de Ingreso *</label>
                    <input type="date" id="fechaEmision" required>
                </div>

                <!-- Condici√≥n de Pago (Antes Forma de Pago) -->
                <div class="form-group">
                    <label for="formaPago">Condici√≥n de Pago *</label>
                    <select id="formaPago" onchange="toggleCondicionPago()">
                        <option value="CONTADO">CONTADO</option>
                        <option value="CREDITO">CR√âDITO</option>
                    </select>
                </div>

                <!-- Medio de Pago (Nuevo) -->
                <div class="form-group" id="containerMedioPago">
                    <label for="medioPago">Medio de Pago *</label>
                    <select id="medioPago" onchange="toggleMedioPago()">
                        <option value="EFECTIVO">EFECTIVO</option>
                        <option value="TRANSFERENCIA">TRANSFERENCIA</option>
                        <option value="BILLETERA_DIGITAL">BILLETERA DIGITAL</option>
                        <option value="NOTA_CREDITO">NOTA DE CR√âDITO</option>
                    </select>
                </div>

                <!-- Referencia de Pago (Nuevo) -->
                <div class="form-group" id="containerReferencia" style="display: none;">
                    <label for="referenciaPago">Referencia / Nro. Operaci√≥n *</label>
                    <input type="text" id="referenciaPago" placeholder="Ingrese n√∫mero de referencia">
                </div>

                <!-- Campos Cr√©dito (Condicionales) -->
                <div class="form-group-row" id="containerCredito"
                    style="display: none; background: #fff7ed; padding: 1rem; border-radius: 8px; border: 1px solid #ffedd5; grid-column: 1 / -1; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                    <div class="form-group">
                        <label for="montoInicial">Pago Inicial (S/)</label>
                        <input type="number" id="montoInicial" min="0" step="0.01" value="0.00"
                            oninput="calcularSaldo()">
                    </div>
                    <div class="form-group">
                        <label for="saldoPendiente">Saldo Pendiente (S/)</label>
                        <input type="number" id="saldoPendiente" readonly
                            style="background-color: #f1f5f9; font-weight: bold;">
                    </div>
                    <div class="form-group">
                        <label for="fechaVencimiento">Fecha Vencimiento *</label>
                        <input type="date" id="fechaVencimiento">
                    </div>
                </div>

                <!-- Secci√≥n Documento (Full Width al final) -->
                <div
                    style="grid-column: 1 / -1; display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem; margin-top: 1rem; border-top: 1px solid #e2e8f0; padding-top: 1.5rem;">
                    <div class="form-group">
                        <label for="tipoDocumento">Tipo de Documento</label>
                        <select id="tipoDocumento">
                            <option value="FACTURA">FACTURA</option>
                            <option value="BOLETA">BOLETA</option>
                            <option value="SIN_COMPROBANTE">SIN COMPROBANTE</option>
                        </select>
                    </div>

                    <!-- Contenedor para ocultar/mostrar -->
                    <div id="containerSerieNumero" style="display: contents;">
                        <div class="form-group">
                            <label for="serieDocumento">Serie</label>
                            <input type="text" id="serieDocumento" placeholder="F001"
                                style="text-transform: uppercase;">
                        </div>
                        <div class="form-group">
                            <label for="numeroDocumento">N√∫mero</label>
                            <input type="text" id="numeroDocumento" placeholder="0000001">
                        </div>
                        <div class="form-group">
                            <label for="fechaDocumento">Fecha Emisi√≥n Doc.</label>
                            <input type="date" id="fechaDocumento">
                        </div>
                    </div>
                </div>
            </form>
        </section>

        <!-- 2. Detalle de Items -->
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">üì¶ Detalle de Items</h2>
            </div>

            <div class="items-grid" style="margin-bottom: 1.5rem;">
                <!-- 1. Buscador (Span 2) -->
                <div class="form-group search-group">
                    <label>Buscar Item (Nombre o C√≥digo)</label>
                    <div class="search-container">
                        <span class="search-icon-input">üîç</span>
                        <input type="text" id="productoBusqueda" class="search-input"
                            placeholder="Escriba para buscar producto..." autocomplete="off">
                        <div id="resultadosBusqueda" class="search-results">
                            <!-- Resultados din√°micos -->
                        </div>
                    </div>
                </div>

                <!-- 2. Cantidad (Span 1) -->
                <div class="form-group cantidad-group">
                    <label for="cantidadInput">Cantidad <span id="unidadMedidaDisplay"
                            style="font-weight: normal; color: var(--secondary-color); font-size: 0.9em;"></span></label>
                    <input type="number" id="cantidadInput" min="0.01" step="0.01" value="1">
                </div>

                <!-- 3. Modo de Ingreso (Span 1) - Row 2 -->
                <div class="form-group modo-group">
                    <label for="modoPrecio">Modo de Ingreso</label>
                    <select id="modoPrecio" onchange="recalcularPrecioUnitarioVisual()">
                        <option value="PRECIO_UNITARIO" selected>Precio Unitario</option>
                        <option value="VALOR_UNITARIO">Valor Unitario (Sin IGV)</option>
                        <option value="PRECIO_TOTAL">Precio Total</option>
                        <option value="VALOR_TOTAL">Valor Total (Sin IGV)</option>
                    </select>
                </div>

                <!-- 4. Monto (Span 1) - Row 2 -->
                <div class="form-group monto-group">
                    <label for="montoInput">Monto</label>
                    <input type="number" id="montoInput" min="0" step="0.0001" placeholder="0.00"
                        oninput="recalcularPrecioUnitarioVisual()">
                    <!-- Input Oculto que usa el sistema (Precio Unitario Final) -->
                    <input type="hidden" id="precioInput">
                </div>

                <!-- 5. Bot√≥n Agregar (Span 1) - Row 2 -->
                <div class="form-group button-group">
                    <button type="button" class="btn btn-secondary" onclick="agregarProducto()"
                        style="width: 100%; justify-content: center;">
                        + Agregar Item
                    </button>
                </div>
            </div>

            <div class="table-container">
                <table id="tablaDetalle">
                    <thead>
                        <tr>
                            <th>C√≥digo</th>
                            <th>Descripci√≥n</th>
                            <th>Unidad</th>
                            <th class="col-number">Cant.</th>
                            <th class="col-number">Precio Unit.</th>
                            <th class="col-number">Valor Compra</th>
                            <th class="col-number">IGV</th>
                            <th class="col-number">Total</th>
                            <th class="col-action" style="min-width: 150px;">Perecible /
                                Vencimiento</th>
                            <th class="col-action"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas din√°micas -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 3. Otros Egresos Asociados -->
        <section class="card">
            <div class="card-header">
                <h2 class="card-title">üöõ Otros Egresos Asociados (Fletes, Seguros, etc.)</h2>
            </div>

            <!-- Fila 1: Descripci√≥n y Monto -->
            <div class="form-grid" style="margin-bottom: 1rem;">
                <div class="form-group" style="flex: 2;">
                    <label for="gastoDescripcion">Descripci√≥n del Gasto</label>
                    <input type="text" id="gastoDescripcion" list="listaGastos" placeholder="Seleccione o escriba..."
                        autocomplete="off">
                    <datalist id="listaGastos">
                        <option value="Flete Interprovincial">
                        <option value="Flete Local">
                        <option value="Seguro de Carga">
                        <option value="Estiba/Desestiba">
                    </datalist>
                </div>
                <div class="form-group">
                    <label for="gastoMonto">Monto Total</label>
                    <input type="number" id="gastoMonto" min="0" step="0.01" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label for="gastoConFactura">¬øCon Factura?</label>
                    <select id="gastoConFactura" onchange="toggleCamposGasto()">
                        <option value="false">NO (Sin IGV)</option>
                        <option value="true">S√ç (Tiene IGV)</option>
                    </select>
                </div>
                <div class="form-group">
                    <button type="button" class="btn btn-secondary" onclick="agregarGasto()">
                        + Agregar Gasto
                    </button>
                </div>
            </div>

            <!-- Fila 2: Datos de Factura (Oculto por defecto) -->
            <div class="form-grid" id="gastoDatosFactura"
                style="display: none; margin-bottom: 1rem; background: #f8fafc; padding: 1rem; border-radius: 8px;">
                <div class="form-group" style="flex: 2;">
                    <label for="gastoProveedor">Proveedor del Servicio</label>
                    <select id="gastoProveedor">
                        <option value="">Seleccionar proveedor...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="gastoSerie">Serie</label>
                    <input type="text" id="gastoSerie" placeholder="F001">
                </div>
                <div class="form-group">
                    <label for="gastoNumero">N√∫mero</label>
                    <input type="text" id="gastoNumero" placeholder="000123">
                </div>
                <div class="form-group">
                    <label for="gastoFecha">Fecha Emisi√≥n</label>
                    <input type="date" id="gastoFecha">
                </div>
            </div>

            <div class="table-container" style="margin-top: 1rem;">
                <table id="tablaGastos">
                    <thead>
                        <tr>
                            <th>Descripci√≥n</th>
                            <th>Proveedor / Doc</th>
                            <th>¬øFactura?</th>
                            <th class="col-number">Monto</th>
                            <th class="col-number">Valor Gasto</th>
                            <th class="col-number">IGV Gasto</th>
                            <th class="col-action"></th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Filas din√°micas -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- 4. Totales -->
        <div class="totals-section">
            <div class="totals-card">
                <div class="total-row">
                    <span>Subtotal Items (Valor Venta):</span>
                    <span id="lblSubtotalItems">S/ 0.00</span>
                </div>
                <div class="total-row">
                    <span>Subtotal Gasto (Valor Venta):</span>
                    <span id="lblSubtotalGastos">S/ 0.00</span>
                </div>
                <div class="total-row">
                    <span>IGV Items (18%):</span>
                    <span id="lblIGVItems">S/ 0.00</span>
                </div>
                <div class="total-row">
                    <span>IGV Gasto (18%):</span>
                    <span id="lblIGVGastos">S/ 0.00</span>
                </div>
                <hr>
                <div class="total-row">
                    <span>Total Items:</span>
                    <span id="lblTotalItems">S/ 0.00</span>
                </div>
                <div class="total-row">
                    <span>Total Gasto:</span>
                    <span id="lblTotalGastos">S/ 0.00</span>
                </div>
                <div class="total-row final" style="white-space: nowrap; align-items: center;">
                    <span>Costo de Adquisici√≥n Total:</span>
                    <span id="lblCostoTotal" style="margin-left: 1rem;">S/ 0.00</span>
                </div>
            </div>
        </div>

        <!-- Botones de Acci√≥n -->
        <div class="actions-footer">
            <button type="button" class="btn btn-secondary"
                onclick="window.location.href='gestion_inventarios.html'">Cancelar</button>
            <button type="button" class="btn btn-primary" onclick="solicitarConfirmacion()">Guardar Ingreso</button>
        </div>
    </main>

    <!-- Modal de Confirmaci√≥n de Costos -->
    <div id="modalCostos" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Confirmaci√≥n de Costos de Adquisici√≥n</h3>
                <button class="btn-icon" onclick="cerrarModalCostos()">‚úï</button>
            </div>
            <div class="modal-body">
                <p style="margin-bottom: 1rem; color: var(--secondary-color);">
                    Por favor, revise los <strong>Costos de Adquisici√≥n Unitarios</strong> antes de guardar.
                    Este valor ser√° el nuevo costo promedio en Kardex.
                </p>

                <div class="table-container">
                    <table id="tablaResumenCostos">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="col-number">Precio Compra<br><small>(Base)</small></th>
                                <th class="col-number">+ Gasto Asig.<br><small>(Prorrateo)</small></th>
                                <th class="col-number highlight">= Costo Unit.<br><small>(Final)</small></th>
                                <th class="col-number">Costo Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Llenado din√°micamente -->
                        </tbody>
                    </table>
                </div>

                <div class="totals-summary"
                    style="margin-top: 1.5rem; text-align: right; font-weight: bold; white-space: nowrap;">
                    <p>Total Documento: <span id="resumenTotalDoc">S/ 0.00</span></p>
                    <p>Total Gastos: <span id="resumenTotalGastos">S/ 0.00</span></p>
                    <p
                        style="color: var(--primary-color); font-size: 1.1rem; margin-top: 0.5rem; display: flex; justify-content: flex-end; gap: 1rem; align-items: center;">
                        Costo de Adquisici√≥n Total: <span id="resumenCostoTotal">S/ 0.00</span>
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="cerrarModalCostos()">Corregir</button>
                <button class="btn btn-primary" onclick="confirmarGuardado()">‚úÖ Aprobar y Guardar</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast">
        <span id="toastIcon"></span>
        <span id="toastMessage"></span>
    </div>

    <style>
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(2px);
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 1rem;
        }

        .modal-header h3 {
            font-size: 1.25rem;
            color: var(--primary-color);
            margin: 0;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        /* Highlight column in summary */
        .col-number.highlight {
            background-color: #eff6ff;
            color: var(--primary-color);
            font-weight: 700;
            border-left: 1px solid #dbeafe;
            border-right: 1px solid #dbeafe;
        }
    </style>

    <script>
        // ============================================
        // CONFIGURACI√ìN SUPABASE
        // ============================================
        const SUPABASE_URL = 'https://snyfzenjapyybbfqrnku.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNueWZ6ZW5qYXB5eWJiZnFybmt1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTAzNTQsImV4cCI6MjA3ODY2NjM1NH0.JyuhgrbYjCt7XJiWhptI6Q2MM9JDKK49fnQdMlHxjlQ';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // ============================================
        // ESTADO GLOBAL
        // ============================================
        let detalleIngreso = [];
        let gastosIngreso = []; // Nuevo estado para gastos
        let productosCache = [];
        let proveedoresCache = []; // Cache para proveedores

        // ============================================
        // INICIALIZACI√ìN
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            document.getElementById('fechaActual').textContent = new Date().toLocaleDateString('es-PE', {
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'
            });
            // Fecha por defecto: Hoy (Zona Horaria Per√∫)
            const hoy = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Lima' }); // YYYY-MM-DD
            document.getElementById('fechaDocumento').value = hoy;
            document.getElementById('fechaEmision').value = hoy;
            document.getElementById('gastoFecha').valueAsDate = new Date();

            // Listener para cambio de documento (recalcular IGV)
            document.getElementById('tipoDocumento').addEventListener('change', (e) => {
                toggleSerieNumero();
                recalcularTodo();
            });

            await cargarDatosIniciales();
            toggleSerieNumero(); // Estado inicial
            toggleCondicionPago(); // Estado inicial
        });

        // --- L√≥gica de Documento ---
        function toggleSerieNumero() {
            const tipo = document.getElementById('tipoDocumento').value;
            const container = document.getElementById('containerSerieNumero');

            if (tipo === 'SIN_COMPROBANTE') {
                container.style.display = 'none';
            } else {
                container.style.display = 'contents'; // Mantiene el layout grid
            }
        }

        // --- L√≥gica de Forma de Pago y Cr√©dito ---
        function toggleCondicionPago() {
            const forma = document.getElementById('formaPago').value;
            const containerCredito = document.getElementById('containerCredito');
            const containerMedioPago = document.getElementById('containerMedioPago');
            const containerReferencia = document.getElementById('containerReferencia');

            // Resetear valores al cambiar
            if (forma === 'CONTADO') {
                containerCredito.style.display = 'none';
                containerMedioPago.style.display = 'flex'; // Mostrar Medio de Pago
                toggleMedioPago(); // Re-evaluar visibilidad de referencia

                // Limpiar campos cr√©dito
                document.getElementById('montoInicial').value = '0.00';
                document.getElementById('saldoPendiente').value = '0.00';
                document.getElementById('fechaVencimiento').value = '';
                document.getElementById('fechaVencimiento').required = false;
            } else {
                // CR√âDITO
                containerCredito.style.display = 'grid'; // Usar grid del estilo inline
                containerMedioPago.style.display = 'none'; // Ocultar Medio de Pago
                containerReferencia.style.display = 'none'; // Ocultar Referencia

                document.getElementById('fechaVencimiento').required = true;
                calcularSaldo();
            }
        }

        function toggleMedioPago() {
            const medio = document.getElementById('medioPago').value;
            const containerReferencia = document.getElementById('containerReferencia');
            const inputReferencia = document.getElementById('referenciaPago');
            const labelReferencia = document.querySelector("label[for='referenciaPago']");

            // Mostrar referencia para Transferencia, Billetera Digital y Nota de Cr√©dito
            if (['TRANSFERENCIA', 'BILLETERA_DIGITAL', 'NOTA_CREDITO'].includes(medio)) {
                containerReferencia.style.display = 'flex';
                inputReferencia.required = true;

                if (medio === 'NOTA_CREDITO') {
                    labelReferencia.textContent = 'Serie - Nro. de la NC *';
                    inputReferencia.placeholder = 'Ej: E001-2';
                } else if (medio === 'TRANSFERENCIA') {
                    labelReferencia.textContent = 'Banco de Origen / Nro. Operaci√≥n *';
                    inputReferencia.placeholder = 'Ej: BCP / Nro. Op:12345';
                } else if (medio === 'BILLETERA_DIGITAL') {
                    labelReferencia.textContent = 'Aplicativo / Nro. Operaci√≥n *';
                    inputReferencia.placeholder = 'Ej: YAPE / Nro. Op:12345';
                }
            } else {
                containerReferencia.style.display = 'none';
                inputReferencia.required = false;
                inputReferencia.value = '';
            }
        }

        function calcularSaldo() {
            // Usar el ID correcto para el total (lblCostoTotal)
            const total = parseFloat(document.getElementById('lblCostoTotal').textContent.replace('S/ ', '').replace(/,/g, '')) || 0;
            const inicial = parseFloat(document.getElementById('montoInicial').value) || 0;
            const saldo = total - inicial;
            document.getElementById('saldoPendiente').value = saldo.toFixed(2);
        }

        async function cargarDatosIniciales() {
            try {
                // 1. Cargar Tipos de Ingreso
                const { data: tipos } = await supabase
                    .from('tipos_ingresos')
                    .select('id, nombre')
                    .eq('activo', true);

                llenarSelect('tipoIngreso', tipos, 'nombre');

                // 2. Cargar Proveedores
                const { data: proveedores } = await supabase
                    .from('proveedores')
                    .select('id, razon_social')
                    .eq('activo', true);

                proveedoresCache = proveedores || [];
                llenarSelect('proveedor', proveedores, 'razon_social');
                llenarSelect('gastoProveedor', proveedores, 'razon_social'); // Llenar tambi√©n en gastos

                // 3. Cargar Almacenes
                const { data: almacenes } = await supabase
                    .from('almacenes')
                    .select('id, nombre')
                    .eq('activo', true);

                llenarSelect('almacen', almacenes, 'nombre');

                // 4. Cargar Items (Cache simple) - INCLUYENDO PROVEEDOR
                const { data: productos } = await supabase
                    .from('items')
                    .select('id, codigo, descripcion, proveedor_id, unidad_medida:unidades_medida(codigo)')
                    .eq('activo', true);

                productosCache = productos || [];
                // llenarSelectProductos(productosCache); // REMOVED: No longer using dropdown for products

            } catch (error) {
                console.error('Error cargando datos:', error);
                mostrarToast('Error al cargar datos iniciales', 'error');
            }
        }

        function llenarSelect(id, data, labelField) {
            const select = document.getElementById(id);
            select.innerHTML = '<option value="">Seleccionar...</option>';
            data?.forEach(item => {
                const option = document.createElement('option');
                option.value = item.id;
                option.textContent = item[labelField];
                select.appendChild(option);
            });
        }

        // ============================================
        // L√ìGICA DE SELECCI√ìN DE PRODUCTOS (DROPDOWN)
        // ============================================

        // ============================================
        // L√ìGICA DE B√öSQUEDA Y SELECCI√ìN (GOOGLE STYLE)
        // ============================================

        // Inicializar Buscador
        document.addEventListener('DOMContentLoaded', () => {
            const buscador = document.getElementById('productoBusqueda');

            // Evento Input con Debounce
            buscador.addEventListener('input', debounce(async (e) => {
                // Limpiar selecci√≥n previa al escribir para evitar inconsistencias
                e.target.dataset.id = '';
                itemSeleccionadoActual = null;

                const termino = e.target.value;
                if (termino.length < 2) {
                    document.getElementById('resultadosBusqueda').style.display = 'none';
                    return;
                }
                await buscarProductos(termino);
            }, 300));

            // Cerrar resultados al hacer clic fuera
            document.addEventListener('click', (e) => {
                if (!buscador.contains(e.target) && !document.getElementById('resultadosBusqueda').contains(e.target)) {
                    document.getElementById('resultadosBusqueda').style.display = 'none';
                }
            });

            // Listeners adicionales para el rec√°lculo de precios
            document.getElementById('cantidadInput').addEventListener('input', recalcularPrecioUnitarioVisual);
            document.getElementById('tipoDocumento').addEventListener('change', recalcularPrecioUnitarioVisual);
        });

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        async function buscarProductos(termino) {
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            resultadosDiv.style.display = 'block';
            resultadosDiv.innerHTML = '<div style="padding:10px; text-align:center; color:#666;">Buscando...</div>';

            try {
                const { data: productos, error } = await supabase
                    .from('items')
                    .select('id, codigo, descripcion, unidad_medida:unidades_medida(codigo), proveedor_id')
                    .or(`descripcion.ilike.%${termino}%,codigo.ilike.%${termino}%`)
                    .eq('activo', true)
                    .limit(10);

                if (error) throw error;

                renderizarResultados(productos);
            } catch (error) {
                console.error('Error buscando:', error);
                resultadosDiv.innerHTML = '<div style="padding:10px; text-align:center; color:red;">Error al buscar</div>';
            }
        }

        function renderizarResultados(productos) {
            const resultadosDiv = document.getElementById('resultadosBusqueda');
            resultadosDiv.innerHTML = '';

            if (!productos || productos.length === 0) {
                resultadosDiv.innerHTML = '<div style="padding:10px; text-align:center; color:#666;">No se encontraron productos</div>';
                return;
            }

            productos.forEach(prod => {
                const div = document.createElement('div');
                div.className = 'result-item';
                div.innerHTML = `
                    <div>
                        <strong>${prod.descripcion}</strong>
                        <span class="item-code">${prod.codigo}</span>
                    </div>
                `;
                div.onclick = () => seleccionarProducto(prod);
                resultadosDiv.appendChild(div);
            });
        }

        let itemSeleccionadoActual = null;

        function seleccionarProducto(producto) {
            const input = document.getElementById('productoBusqueda');
            input.value = producto.codigo + ' - ' + producto.descripcion;
            input.dataset.id = producto.id; // Guardar ID oculto

            // Guardar el objeto completo para usarlo al agregar
            itemSeleccionadoActual = producto;

            document.getElementById('resultadosBusqueda').style.display = 'none';

            // L√≥gica existente de verificaci√≥n
            verificarProveedorItem(producto);

            // Foco a cantidad
            document.getElementById('cantidadInput').focus();
        }

        function agregarProducto() {
            // Validar Serie/N√∫mero antes de agregar (si aplica)
            const tipoDocumento = document.getElementById('tipoDocumento').value;
            const serie = document.getElementById('serieDocumento').value;
            const numero = document.getElementById('numeroDocumento').value;

            if (tipoDocumento !== 'SIN_COMPROBANTE' && (!serie || !numero)) {
                mostrarToast('Ingrese Serie y N√∫mero del documento principal antes de agregar items', 'warning');
                document.getElementById('serieDocumento').focus();
                return;
            }

            const productoId = document.getElementById('productoBusqueda').dataset.id;
            const cantidad = parseFloat(document.getElementById('cantidadInput').value);
            const precioUnitario = parseFloat(document.getElementById('precioInput').value); // PRECIO COMPRA (Inc. IGV si aplica)

            if (!productoId || !cantidad || isNaN(precioUnitario)) {
                mostrarToast('Complete todos los campos del item', 'warning');
                return;
            }

            // Usar el item seleccionado guardado globalmente
            const producto = itemSeleccionadoActual;

            if (!producto || String(producto.id) !== String(productoId)) {
                mostrarToast('Error: Vuelva a buscar y seleccionar el producto', 'error');
                return;
            }

            // Agregar al estado (los c√°lculos se hacen en recalcularTodo)
            detalleIngreso.push({
                productoId,
                codigo: producto.codigo,
                descripcion: producto.descripcion,
                unidad: producto.unidad_medida?.codigo || 'UND',
                cantidad,
                precioUnitario, // Guardamos el input original
                // Valores calculados:
                valorUnitario: 0,
                igvUnitario: 0,
                subtotal: 0,
                igvTotal: 0,
                total: 0,
                // Costos distribuidos
                gastoAsignado: 0,
                costoAdquisicionTotal: 0,
                costoAdquisicionUnitario: 0,
                // Nuevos campos para Perecibles
                esPerecible: false,
                fechaVencimiento: null
            });

            recalcularTodo();
            limpiarInputsProducto();
        }

        // ...

        function limpiarInputsProducto() {
            document.getElementById('productoBusqueda').value = '';
            document.getElementById('productoBusqueda').dataset.id = '';
            itemSeleccionadoActual = null; // Limpiar selecci√≥n
            document.getElementById('unidadMedidaDisplay').textContent = '';
            document.getElementById('cantidadInput').value = '1';

            // Limpiar inputs de precios
            document.getElementById('precioInput').value = '';
            document.getElementById('montoInput').value = '0.00';
            document.getElementById('montoInput').setAttribute('value', '0.00');

            // Resetear modo a precio unitario
            document.getElementById('modoPrecio').value = 'PRECIO_UNITARIO';

            document.getElementById('productoBusqueda').focus();
        }

        // ============================================
        // L√ìGICA DE GASTOS ASOCIADOS
        // ============================================
        function toggleCamposGasto() {
            const conFactura = document.getElementById('gastoConFactura').value === 'true';
            const divDatos = document.getElementById('gastoDatosFactura');

            if (conFactura) {
                divDatos.style.display = 'grid';
                // Llenar proveedor si ya est√° cargado
                const proveedorSelect = document.getElementById('gastoProveedor');
                if (proveedorSelect.options.length <= 1 && proveedoresCache.length > 0) {
                    llenarSelect('gastoProveedor', proveedoresCache, 'razon_social');
                }
            } else {
                divDatos.style.display = 'none';
            }
        }

        function verificarProveedorItem(item) {
            const uomDisplay = document.getElementById('unidadMedidaDisplay');
            const proveedorSelect = document.getElementById('proveedor');

            if (!item) {
                uomDisplay.textContent = '';
                return;
            }

            // Mostrar Unidad de Medida
            if (item.unidad_medida) {
                uomDisplay.textContent = `(${item.unidad_medida.codigo})`;
            } else {
                uomDisplay.textContent = '';
            }

            // Asignar Proveedor Autom√°ticamente
            if (item.proveedor_id) {
                // Si ya hay un proveedor seleccionado y es diferente, avisar del cambio
                if (proveedorSelect.value !== "" && proveedorSelect.value != item.proveedor_id) {
                    mostrarToast('‚ö†Ô∏è Se actualiz√≥ el proveedor seg√∫n el item seleccionado', 'warning');
                } else { // Simplificado: siempre asigna si hay proveedor_id
                    mostrarToast('‚úÖ Proveedor asignado autom√°ticamente', 'info');
                }

                proveedorSelect.value = item.proveedor_id;
            }
        }

        function agregarGasto() {
            const descripcion = document.getElementById('gastoDescripcion').value;
            const monto = parseFloat(document.getElementById('gastoMonto').value);
            const conFactura = document.getElementById('gastoConFactura').value === 'true';

            if (!descripcion || isNaN(monto) || monto <= 0) {
                mostrarToast('Ingrese descripci√≥n y monto v√°lido', 'warning');
                return;
            }

            // Datos adicionales si es con factura
            let proveedorId = null;
            let proveedorNombre = '';
            let serie = '';
            let numero = '';
            let fecha = '';

            if (conFactura) {
                proveedorId = document.getElementById('gastoProveedor').value;
                serie = document.getElementById('gastoSerie').value;
                numero = document.getElementById('gastoNumero').value;
                fecha = document.getElementById('gastoFecha').value;

                if (!proveedorId || !serie || !numero) {
                    mostrarToast('Complete los datos de la factura del gasto', 'warning');
                    return;
                }

                const prov = proveedoresCache.find(p => p.id === proveedorId);
                proveedorNombre = prov ? prov.razon_social : '';
            }

            gastosIngreso.push({
                descripcion,
                monto,
                conFactura,
                proveedorId,
                proveedorNombre,
                serie,
                numero,
                fecha,
                valor: conFactura ? monto / 1.18 : monto,
                igv: conFactura ? monto - (monto / 1.18) : 0
            });

            recalcularTodo();
            limpiarInputsGasto();
        }

        function eliminarGasto(index) {
            gastosIngreso.splice(index, 1);
            recalcularTodo();
        }

        function limpiarInputsGasto() {
            document.getElementById('gastoDescripcion').value = '';
            document.getElementById('gastoMonto').value = '';
            document.getElementById('gastoConFactura').value = 'false';
            document.getElementById('gastoProveedor').value = '';
            document.getElementById('gastoSerie').value = '';
            document.getElementById('gastoNumero').value = '';
            document.getElementById('gastoFecha').valueAsDate = new Date();
            toggleCamposGasto();
            document.getElementById('gastoDescripcion').focus();
        }

        // Helper for currency formatting (Force en-US to guarantee comma separators as requested)
        const formatMoney = (amount) => {
            return parseFloat(amount || 0).toLocaleString('en-US', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        };

        const formatMoney4 = (amount) => {
            return parseFloat(amount || 0).toLocaleString('en-US', {
                minimumFractionDigits: 4,
                maximumFractionDigits: 4
            });
        };

        function renderizarTabla() {
            const tbody = document.querySelector('#tablaDetalle tbody');
            tbody.innerHTML = '';

            detalleIngreso.forEach((item, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.codigo}</td>
                    <td>${item.descripcion}</td>
                    <td>${item.unidad}</td>
                    <td class="col-number">${item.cantidad.toFixed(2)}</td>
                    <td class="col-number">${formatMoney4(item.precioUnitario)}</td>
                    <td class="col-number">${formatMoney(item.subtotal)}</td>
                    <td class="col-number">${formatMoney(item.igvTotal)}</td>
                    <td class="col-number">${formatMoney(item.total)}</td>
                    <td class="col-action">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 5px;">
                            <label style="font-size: 0.8rem; display: flex; align-items: center; gap: 5px; cursor: pointer; user-select: none;">
                                <input type="checkbox" ${item.esPerecible ? 'checked' : ''} onchange="togglePerecible(${index})">
                                Perecible
                            </label>
                            <input type="date" 
                                   value="${item.fechaVencimiento || ''}" 
                                   onchange="updateVencimiento(${index}, this.value)"
                                   style="display: ${item.esPerecible ? 'block' : 'none'}; font-size: 0.8rem; padding: 2px; border: 1px solid #ccc; border-radius: 4px; width: 120px;"
                            >
                        </div>
                    </td>
                    <td class="col-action">
                        <button class="btn-icon" onclick="editarFila(${index})" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" onclick="eliminarFila(${index})" title="Eliminar">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ... existing code ...

        function renderizarResumenCostos() {
            const tbody = document.getElementById('tablaResumenCostos').querySelector('tbody');
            tbody.innerHTML = '';

            let totalDoc = 0;
            let totalGastos = 0;
            let totalCosto = 0;

            detalleIngreso.forEach(item => {
                const gastoUnitario = item.gastoAsignado / item.cantidad;

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>
                        <strong>${item.codigo}</strong><br>
                        ${item.descripcion}
                    </td>
                    <td class="col-number">S/ ${formatMoney4(item.precioUnitario)}</td>
                    <td class="col-number" style="color: var(--danger-color);">+ S/ ${formatMoney4(gastoUnitario)}</td>
                    <td class="col-number highlight">S/ ${formatMoney4(item.costoAdquisicionUnitario)}</td>
                    <td class="col-number">S/ ${formatMoney(item.costoAdquisicionTotal)}</td>
                `;
                tbody.appendChild(tr);

                totalDoc += item.total;
                totalCosto += item.costoAdquisicionTotal;
            });

            totalGastos = gastosIngreso.reduce((sum, g) => sum + g.monto, 0);

            document.getElementById('resumenTotalDoc').textContent = `S/ ${formatMoney(totalDoc)}`;
            document.getElementById('resumenTotalGastos').textContent = `S/ ${formatMoney(totalGastos)}`;
            document.getElementById('resumenCostoTotal').textContent = `S/ ${formatMoney(totalCosto)}`;
        }

        function renderizarGastos() {
            const tbody = document.querySelector('#tablaGastos tbody');
            tbody.innerHTML = '';

            gastosIngreso.forEach((gasto, index) => {
                let detalleDoc = '-';
                if (gasto.conFactura) {
                    detalleDoc = `<small>${gasto.proveedorNombre}<br>${gasto.serie}-${gasto.numero}</small>`;
                }

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${gasto.descripcion}</td>
                    <td>${detalleDoc}</td>
                    <td>${gasto.conFactura ? 'S√ç' : 'NO'}</td>
                    <td class="col-number">${formatMoney(gasto.monto)}</td>
                    <td class="col-number">${formatMoney(gasto.valor)}</td>
                    <td class="col-number">${formatMoney(gasto.igv)}</td>
                    <td class="col-action">
                        <button class="btn-icon" onclick="editarGasto(${index})" title="Editar">‚úèÔ∏è</button>
                        <button class="btn-icon btn-delete" onclick="eliminarGasto(${index})" title="Eliminar">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function editarGasto(index) {
            const gasto = gastosIngreso[index];

            // Cargar datos en inputs
            document.getElementById('gastoDescripcion').value = gasto.descripcion;
            document.getElementById('gastoMonto').value = gasto.monto;
            document.getElementById('gastoConFactura').value = gasto.conFactura.toString();

            toggleCamposGasto(); // Mostrar/ocultar campos de factura

            if (gasto.conFactura) {
                document.getElementById('gastoProveedor').value = gasto.proveedorId;
                document.getElementById('gastoSerie').value = gasto.serie;
                document.getElementById('gastoNumero').value = gasto.numero;
                document.getElementById('gastoFecha').value = gasto.fecha;
            }

            // Eliminar de la lista
            eliminarGasto(index);

            // Foco
            document.getElementById('gastoDescripcion').focus();
            mostrarToast('Gasto cargado para edici√≥n', 'info');
        }

        // ============================================
        // C√ÅLCULOS CENTRALIZADOS
        // ============================================
        function esConFactura() {
            const tipoDoc = document.getElementById('tipoDocumento');
            return tipoDoc && tipoDoc.value === 'FACTURA';
        }

        function recalcularTodo() {
            const conFactura = esConFactura();

            // 1. Calcular valores base de items
            let sumaPrecioCompraTotal = 0; // Suma de los "total" de cada item, para prorrateo

            detalleIngreso.forEach(item => {
                // Algoritmo oficial:
                // Si conFactura: Valor = Precio / 1.18
                // Si sinFactura: Valor = Precio

                if (conFactura) {
                    item.valorUnitario = item.precioUnitario / 1.18;
                    item.igvUnitario = item.precioUnitario - item.valorUnitario;
                } else {
                    item.valorUnitario = item.precioUnitario;
                    item.igvUnitario = 0;
                }

                item.subtotal = item.valorUnitario * item.cantidad; // Valor Venta Total
                item.igvTotal = item.igvUnitario * item.cantidad;
                item.total = item.precioUnitario * item.cantidad; // Precio Total (Base para prorrateo)

                sumaPrecioCompraTotal += item.total;
            });

            // 2. Calcular totales de gastos
            const totalGastos = gastosIngreso.reduce((sum, g) => sum + g.monto, 0);
            const subtotalGastos = gastosIngreso.reduce((sum, g) => sum + g.valor, 0);
            const igvGastos = gastosIngreso.reduce((sum, g) => sum + g.igv, 0);

            // 3. Distribuir gastos (Prorrateo por Precio Total)
            detalleIngreso.forEach(item => {
                let proporcion = 0;
                if (sumaPrecioCompraTotal > 0) {
                    proporcion = item.total / sumaPrecioCompraTotal;
                }

                item.gastoAsignado = totalGastos * proporcion;
                item.costoAdquisicionTotal = item.total + item.gastoAsignado;
                item.costoAdquisicionUnitario = item.costoAdquisicionTotal / item.cantidad;
            });

            renderizarTabla();
            renderizarGastos();
            actualizarTotalesGenerales(subtotalGastos, igvGastos, totalGastos);
            calcularSaldo(); // Recalcular saldo si cambia el total
        }

        function actualizarTotalesGenerales(subtotalGastos, igvGastos, totalGastos) {
            const subtotalItems = detalleIngreso.reduce((sum, i) => sum + i.subtotal, 0);
            const igvItems = detalleIngreso.reduce((sum, i) => sum + i.igvTotal, 0);
            const totalItems = detalleIngreso.reduce((sum, i) => sum + i.total, 0);

            const costoTotalAdquisicion = totalItems + totalGastos;

            document.getElementById('lblSubtotalItems').textContent = `S/ ${formatMoney(subtotalItems)}`;
            document.getElementById('lblSubtotalGastos').textContent = `S/ ${formatMoney(subtotalGastos)}`;

            document.getElementById('lblIGVItems').textContent = `S/ ${formatMoney(igvItems)}`;
            document.getElementById('lblIGVGastos').textContent = `S/ ${formatMoney(igvGastos)}`;

            document.getElementById('lblTotalItems').textContent = `S/ ${formatMoney(totalItems)}`;
            document.getElementById('lblTotalGastos').textContent = `S/ ${formatMoney(totalGastos)}`;

            document.getElementById('lblCostoTotal').textContent = `S/ ${formatMoney(costoTotalAdquisicion)}`;
        }



        function editarFila(index) {
            const item = detalleIngreso[index];

            // Cargar datos en inputs
            const inputBusqueda = document.getElementById('productoBusqueda');
            inputBusqueda.value = `${item.codigo} - ${item.descripcion}`;
            inputBusqueda.dataset.id = item.productoId;

            // Restaurar itemSeleccionadoActual
            // Intentamos buscar en cach√© primero
            let producto = productosCache.find(p => p.id === item.productoId);

            if (!producto) {
                // Si no est√° en cach√©, reconstruimos lo m√≠nimo necesario para que agregarProducto funcione
                producto = {
                    id: item.productoId,
                    codigo: item.codigo,
                    descripcion: item.descripcion,
                    unidad_medida: { codigo: item.unidad }
                };
            }

            itemSeleccionadoActual = producto;

            // Verificar proveedor y unidad (solo si tenemos el objeto completo con proveedor_id)
            if (producto.proveedor_id) {
                verificarProveedorItem(producto);
            }

            document.getElementById('cantidadInput').value = item.cantidad;

            // Cargar el monto visual (montoInput) y el precio unitario (precioInput)
            // Asumimos que el usuario quiere ver el precio unitario por defecto al editar
            // O idealmente, deber√≠amos guardar qu√© "modo" us√≥, pero por ahora cargaremos el precio unitario
            document.getElementById('precioInput').value = item.precioUnitario;
            document.getElementById('montoInput').value = item.precioUnitario;
            document.getElementById('modoPrecio').value = 'PRECIO_UNITARIO'; // Resetear modo a precio unitario para consistencia

            // Eliminar de la lista
            eliminarFila(index);

            // Foco
            document.getElementById('cantidadInput').focus();
            mostrarToast('Item cargado para edici√≥n', 'info');
        }

        function eliminarFila(index) {
            detalleIngreso.splice(index, 1);
            recalcularTodo(); // Recalcular totales
        }

        function togglePerecible(index) {
            detalleIngreso[index].esPerecible = !detalleIngreso[index].esPerecible;
            if (!detalleIngreso[index].esPerecible) {
                detalleIngreso[index].fechaVencimiento = null; // Limpiar si se desmarca
            }
            renderizarTabla();
        }

        function updateVencimiento(index, value) {
            detalleIngreso[index].fechaVencimiento = value;
        }

        function limpiarInputsProducto() {
            document.getElementById('productoBusqueda').value = '';
            document.getElementById('productoBusqueda').dataset.id = '';
            document.getElementById('unidadMedidaDisplay').textContent = '';
            document.getElementById('cantidadInput').value = '1';
            document.getElementById('precioInput').value = '';
            document.getElementById('productoBusqueda').focus();
        }

        // ============================================
        // MODAL Y CONFIRMACI√ìN
        // ============================================
        async function solicitarConfirmacion() {
            // Validaciones b√°sicas
            const tipoIngreso = document.getElementById('tipoIngreso').value;
            const proveedor = document.getElementById('proveedor').value;
            const almacen = document.getElementById('almacen').value;
            const fecha = document.getElementById('fechaEmision').value;
            const tipoDocumento = document.getElementById('tipoDocumento').value;
            const serie = document.getElementById('serieDocumento').value;
            const numero = document.getElementById('numeroDocumento').value;
            const fechaDocumento = document.getElementById('fechaDocumento').value;
            const formaPago = document.getElementById('formaPago').value;
            const fechaVencimiento = document.getElementById('fechaVencimiento').value;

            if (!tipoIngreso || !proveedor || !almacen || !fecha) {
                mostrarToast('Complete los datos generales obligatorios', 'warning');
                return;
            }

            if (tipoDocumento !== 'SIN_COMPROBANTE' && tipoDocumento !== 'OTRO' && (!serie || !numero || !fechaDocumento)) {
                mostrarToast('Complete la serie, n√∫mero y fecha del documento principal', 'warning');
                return;
            }

            if (detalleIngreso.length === 0) {
                alert('Debe agregar al menos un item');
                return;
            }

            // Validar Perecibles
            const itemsPereciblesSinFecha = detalleIngreso.filter(i => i.esPerecible && !i.fechaVencimiento);
            if (itemsPereciblesSinFecha.length > 0) {
                const nombres = itemsPereciblesSinFecha.map(i => i.descripcion).join(', ');
                mostrarToast(`‚ö†Ô∏è Faltan fechas de vencimiento en: ${nombres}`, 'warning');
                return;
            }

            // ==========================================
            // VALIDACI√ìN DE INTEGRIDAD CRONOL√ìGICA (SAFE APPEND)
            // ==========================================
            // 1. Obtener fecha actual en Lima (UTC-5)
            const getLimaDate = () => {
                const now = new Date();
                const utc = now.getTime() + (now.getTimezoneOffset() * 60000);
                const limaOffset = -5 * 3600000;
                return new Date(utc + limaOffset).toISOString().split('T')[0];
            };

            const hoyLima = getLimaDate();

            // 2. Validar Futuro
            if (fecha > hoyLima) {
                alert(`‚ùå FECHA INV√ÅLIDA\n\nNo puedes registrar ingresos con fecha futura.\nLa fecha m√°xima permitida es HOY (${hoyLima}).`);
                return;
            }

            // 3. Validar Pasado (PRO: Safe Append por Item)
            try {
                // a. Recolectar IDs de items en el carrito
                const itemIds = detalleIngreso.map(i => i.productoId);

                // b. Calcular "D√≠a Siguiente" a la fecha seleccionada
                // (Buscamos movimientos FUTUROS que rompan la cronolog√≠a)
                const fechaIngresoDate = new Date(fecha + 'T00:00:00');
                fechaIngresoDate.setDate(fechaIngresoDate.getDate() + 1);
                const nextDay = fechaIngresoDate.toISOString().split('T')[0];

                // c. Consultar Kardex: ¬øHay movimientos de ESTOS items en ESTE almac√©n a partir de MA√ëANA?
                const { data: conflictos, error: errorConflictos } = await supabase
                    .from('kardex')
                    .select(`
                        item_id, 
                        fecha_movimiento,
                        items ( codigo, descripcion )
                    `)
                    .eq('almacen_id', almacen)
                    .in('item_id', itemIds)
                    .gte('fecha_movimiento', nextDay);

                if (errorConflictos) throw errorConflictos;

                // d. Analizar Conflictos
                if (conflictos && conflictos.length > 0) {
                    // Agrupar por item para mostrar el conflicto m√°s reciente de cada uno
                    const conflictosMap = {};
                    conflictos.forEach(c => {
                        const id = c.item_id;
                        if (!conflictosMap[id] || c.fecha_movimiento > conflictosMap[id].fecha_movimiento) {
                            conflictosMap[id] = c;
                        }
                    });

                    // Construir Mensaje de Error
                    let mensajeError = `‚ùå BLOQUEO DE SEGURIDAD (SAFE APPEND PRO)\n\n`;
                    mensajeError += `No se puede registrar con fecha ${fecha} porque los siguientes items tienen movimientos posteriores:\n\n`;

                    Object.values(conflictosMap).forEach(c => {
                        const fechaMov = c.fecha_movimiento.split('T')[0];
                        mensajeError += `‚Ä¢ ${c.items.descripcion} (√öltimo: ${fechaMov})\n`;
                    });

                    mensajeError += `\n‚úÖ Soluciones:\n`;
                    mensajeError += `1. Cambie la fecha a una posterior.\n`;
                    mensajeError += `2. O retire estos items y reg√≠strelos en otro documento.`;

                    alert(mensajeError);
                    return;
                }

                // Si no hay conflictos, PASE USTED (Aunque el almac√©n tenga otros movimientos de otros items)

            } catch (errVal) {
                console.error('Error en validaci√≥n Safe Append PRO:', errVal);
                alert('Error interno validando fechas. Ver consola.');
                return;
            }

            if (formaPago === 'CREDITO' && !fechaVencimiento) {
                mostrarToast('Debe indicar la fecha de vencimiento para compras a cr√©dito', 'warning');
                return;
            }

            // Si pasa validaciones, mostrar modal
            renderizarResumenCostos();
            document.getElementById('modalCostos').style.display = 'flex';
        }

        function cerrarModalCostos() {
            document.getElementById('modalCostos').style.display = 'none';
        }

        function recalcularPrecioUnitarioVisual() {
            const modo = document.getElementById('modoPrecio').value;
            const monto = parseFloat(document.getElementById('montoInput').value) || 0;
            const cantidad = parseFloat(document.getElementById('cantidadInput').value) || 1;
            const tipoDoc = document.getElementById('tipoDocumento').value;
            const conFactura = (tipoDoc === 'FACTURA'); // Asumimos l√≥gica est√°ndar

            let precioUnitarioFinal = 0;

            // 1. Calcular Precio Unitario Base (Con IGV si aplica)
            switch (modo) {
                case 'PRECIO_UNITARIO':
                    precioUnitarioFinal = monto;
                    break;
                case 'VALOR_UNITARIO':
                    // Si es valor, y hay factura, agregamos IGV. Si no, es igual.
                    precioUnitarioFinal = conFactura ? (monto * 1.18) : monto;
                    break;
                case 'PRECIO_TOTAL':
                    precioUnitarioFinal = (cantidad > 0) ? (monto / cantidad) : 0;
                    break;
                case 'VALOR_TOTAL':
                    const valorUnitario = (cantidad > 0) ? (monto / cantidad) : 0;
                    precioUnitarioFinal = conFactura ? (valorUnitario * 1.18) : valorUnitario;
                    break;
            }

            // 2. Actualizar Input Oculto (El que usa el sistema)
            document.getElementById('precioInput').value = precioUnitarioFinal.toFixed(4);

            // 3. Feedback visual en consola (opcional)
            // console.log(`Modo: ${modo}, Monto: ${monto}, Cant: ${cantidad} => PU: ${precioUnitarioFinal}`);
        }



        // ============================================
        // GUARDADO FINAL (BD)
        // ============================================
        async function confirmarGuardado() {
            try {
                mostrarToast('Guardando ingreso...', 'info');
                cerrarModalCostos(); // Cerrar modal

                // Recopilar datos (ya validados en solicitarConfirmacion)
                const tipoIngreso = document.getElementById('tipoIngreso').value;
                const proveedor = document.getElementById('proveedor').value;
                const almacen = document.getElementById('almacen').value;
                const fecha = document.getElementById('fechaEmision').value;
                const tipoDocumento = document.getElementById('tipoDocumento').value;
                const serie = document.getElementById('serieDocumento').value;
                const numero = document.getElementById('numeroDocumento').value;
                const fechaDocumento = document.getElementById('fechaDocumento').value;
                const conFactura = esConFactura();

                // Totales globales
                const subtotalGlobal = detalleIngreso.reduce((sum, i) => sum + i.subtotal, 0);
                const igvGlobal = detalleIngreso.reduce((sum, i) => sum + i.igvTotal, 0);
                const totalItems = detalleIngreso.reduce((sum, i) => sum + i.total, 0);
                const totalGastos = gastosIngreso.reduce((sum, g) => sum + g.monto, 0);
                const costoTotal = totalItems + totalGastos;

                // C√°lculos de Pago
                let egresoReal = 0;
                let saldoCredito = 0;
                const formaPago = document.getElementById('formaPago').value;
                const medioPago = document.getElementById('medioPago').value;
                const referenciaPago = document.getElementById('referenciaPago').value;
                const montoInicial = parseFloat(document.getElementById('montoInicial').value) || 0;
                const fechaVencimiento = document.getElementById('fechaVencimiento').value;

                if (formaPago === 'CONTADO') {
                    egresoReal = totalItems;
                    saldoCredito = 0;
                } else {
                    egresoReal = montoInicial;
                    saldoCredito = totalItems - montoInicial;
                }

                // 0. Generar N√∫mero Correlativo
                const { data: numeroIngresoGenerado, error: errorNum } = await supabase
                    .rpc('generar_numero_ingreso');

                if (errorNum) throw new Error("Error generando n√∫mero de ingreso: " + errorNum.message);

                // 1. Cabecera
                const { data: ingresoData, error: errorIngreso } = await supabase
                    .from('ingresos')
                    .insert([{
                        tipo_ingreso_id: tipoIngreso,
                        proveedor_id: proveedor,
                        almacen_destino_id: almacen,
                        fecha_ingreso: fecha,
                        numero_ingreso: numeroIngresoGenerado,
                        estado: 'REGISTRADO',
                        con_factura: conFactura,
                        tipo_documento: tipoDocumento, // Nuevo campo espec√≠fico
                        serie_factura: tipoDocumento === 'SIN_COMPROBANTE' ? null : serie,
                        numero_factura: tipoDocumento === 'SIN_COMPROBANTE' ? null : numero,
                        fecha_documento: tipoDocumento === 'SIN_COMPROBANTE' ? null : fechaDocumento,
                        subtotal: subtotalGlobal,
                        igv_credito_fiscal_total: igvGlobal,
                        costo_adquisicion_total: costoTotal, // INCLUYE GASTOS
                        otros_egresos_total: totalGastos,
                        monto_segun_documentos: totalItems, // Solo lo que se paga al proveedor principal

                        // Campos de Pago
                        forma_pago: formaPago,
                        medio_pago: formaPago === 'CONTADO' ? medioPago : null, // Solo si es contado tiene medio de pago inmediato
                        referencia_pago: (formaPago === 'CONTADO' && ['TRANSFERENCIA', 'BILLETERA_DIGITAL', 'NOTA_CREDITO'].includes(medioPago)) ? referenciaPago : null,
                        pago_inicial: montoInicial,
                        saldo_credito: saldoCredito,
                        egreso_real_pagado: egresoReal,
                        fecha_vencimiento: formaPago === 'CREDITO' ? fechaVencimiento : null
                    }])
                    .select()
                    .single();

                if (errorIngreso) throw errorIngreso;

                const ingresoId = ingresoData.id;

                // 2. Detalle Items
                const detalleParaInsertar = detalleIngreso.map(item => ({
                    ingreso_id: ingresoId,
                    item_id: item.productoId,
                    cantidad: item.cantidad,
                    cantidad_disponible: item.cantidad, // Inicializar stock disponible

                    // Precios de Compra (Input original)
                    precio_compra_unitario: item.precioUnitario,
                    precio_compra_total: item.total,

                    // Valores (Sin IGV)
                    valor_compra_unitario: item.valorUnitario,
                    valor_compra_total: item.subtotal,

                    // IGV
                    igv_credito_fiscal_unitario: item.igvUnitario,
                    igv_credito_fiscal_producto: item.igvTotal,
                    con_factura_producto: conFactura,

                    // Costos Finales (CON GASTOS DISTRIBUIDOS)
                    costo_adquisicion_unitario: item.costoAdquisicionUnitario,
                    costo_adquisicion_total: item.costoAdquisicionTotal,

                    // Gesti√≥n de Perecibles
                    fecha_vencimiento: item.esPerecible ? item.fechaVencimiento : null,

                    // Otros egresos asignados
                    otros_egresos_unitario: item.gastoAsignado / item.cantidad,
                    otros_egresos_total: item.gastoAsignado
                }));

                const { error: errorDetalle } = await supabase
                    .from('ingresos_detalle')
                    .insert(detalleParaInsertar);

                if (errorDetalle) throw errorDetalle;

                // 3. Insertar Gastos Asociados
                if (gastosIngreso.length > 0) {
                    const gastosParaInsertar = gastosIngreso.map(gasto => ({
                        ingreso_id: ingresoId,
                        tipo_gasto: 'OTROS', // O el tipo que corresponda
                        descripcion: gasto.descripcion,
                        precio_gasto: gasto.monto,
                        con_factura_gasto: gasto.conFactura,
                        valor_gasto: gasto.valor,
                        igv_credito_fiscal_gasto: gasto.igv,

                        // Nuevas columnas para trazabilidad completa
                        proveedor_id: gasto.proveedorId || null,
                        serie_factura: gasto.serie || null,
                        numero_factura: gasto.numero || null,
                        fecha_emision: gasto.fecha || null
                    }));

                    const { error: errorGastos } = await supabase
                        .from('gastos_ingreso')
                        .insert(gastosParaInsertar);

                    if (errorGastos) throw errorGastos;
                }

                // 4. Actualizar Stock y Kardex
                // SE ELIMIN√ì LA L√ìGICA MANUAL DE FRONTEND.
                // Ahora el trigger 'tr_ingreso_kardex' en la base de datos se encarga de:
                // a) Crear el registro en la tabla 'kardex'
                // b) Actualizar el 'stock_total' en la tabla 'items'
                // Esto evita la duplicidad de stock que ocurr√≠a al hacerlo en ambos lados.


                mostrarToast('‚úÖ Ingreso registrado correctamente', 'success');
                setTimeout(() => {
                    window.location.href = 'gestion_inventarios.html';
                }, 2000);

            } catch (error) {
                console.error('Error al guardar:', error);
                mostrarToast(`‚ùå Error: ${error.message}`, 'error');
            }
        }

        // ============================================
        // UTILIDADES
        // ============================================
        function mostrarToast(mensaje, tipo = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            toast.className = `toast ${tipo} active`;
            icon.textContent = tipo === 'success' ? '‚úÖ' : (tipo === 'error' ? '‚ùå' : '‚ö†Ô∏è');
            msg.textContent = mensaje;

            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
    </script>

</body>

</html>
